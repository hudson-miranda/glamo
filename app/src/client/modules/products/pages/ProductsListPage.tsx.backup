import { useState, useMemo, useEffect } from 'react';
import { useQuery, listProducts, deleteProduct, listProductBrands, listProductCategories, listSuppliers } from 'wasp/client/operations';
import { useSalonContext } from '../../../hooks/useSalonContext';
import { Card, CardContent } from '../../../../components/ui/card';
import { Button } from '../../../../components/ui/button';
import { Input } from '../../../../components/ui/input';
import { Label } from '../../../../components/ui/label';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
  DropdownMenuCheckboxItem,
} from '../../../../components/ui/dropdown-menu';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '../../../../components/ui/table';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '../../../../components/ui/alert-dialog';
import { Badge } from '../../../../components/ui/badge';
import { 
  Plus, 
  Search, 
  Package, 
  Edit, 
  Trash2,
  Star,
  Filter,
  X,
  ArrowUpDown,
  Settings2,
} from 'lucide-react';
import { ProductFormModal } from '../components/ProductFormModal';
import { ProductStatsCards } from '../components/ProductStatsCards';
import { useToast } from '../../../../components/ui/use-toast';

// Definição de colunas disponíveis
const AVAILABLE_COLUMNS = [
  { id: 'name', label: 'Produto', enabled: true },
  { id: 'category', label: 'Categoria', enabled: true },
  { id: 'brand', label: 'Marca', enabled: true },
  { id: 'cost', label: 'Custo', enabled: true },
  { id: 'price', label: 'Venda', enabled: true },
  { id: 'stock', label: 'Estoque', enabled: true },
  { id: 'supplier', label: 'Fornecedor', enabled: false },
  { id: 'sku', label: 'SKU', enabled: false },
  { id: 'barcode', label: 'Código de Barras', enabled: false },
  { id: 'status', label: 'Status', enabled: true },
];

export default function ProductsListPage() {
  const { activeSalonId } = useSalonContext();
  const { toast } = useToast();
  const [search, setSearch] = useState('');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isColumnsModalOpen, setIsColumnsModalOpen] = useState(false);
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
  const [selectedProduct, setSelectedProduct] = useState<any>(null);
  const [productToDelete, setProductToDelete] = useState<any>(null);
  
  // Filtros
  const [filterCategory, setFilterCategory] = useState<string>('all');
  const [filterBrand, setFilterBrand] = useState<string>('all');
  const [filterSupplier, setFilterSupplier] = useState<string>('all');
  const [filterLowStock, setFilterLowStock] = useState(false);
  const [filterStatus, setFilterStatus] = useState<string>('all');
  
  // Ordenação
  const [sortBy, setSortBy] = useState<string>('name');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('asc');
  
  // Colunas visíveis
  const [visibleColumns, setVisibleColumns] = useState<string[]>(
    AVAILABLE_COLUMNS.filter(col => col.enabled).map(col => col.id)
  );

  const { data, isLoading, error, refetch } = useQuery(listProducts, { 
    salonId: activeSalonId || '',
    includeDeleted: false,
  }, {
    enabled: !!activeSalonId,
  });

  const { data: brandsData } = useQuery(listProductBrands, { 
    salonId: activeSalonId || '' 
  }, {
    enabled: !!activeSalonId,
  });
  
  const { data: categoriesData } = useQuery(listProductCategories, { 
    salonId: activeSalonId || '' 
  }, {
    enabled: !!activeSalonId,
  });
  
  const { data: suppliersData } = useQuery(listSuppliers, { 
    salonId: activeSalonId || '' 
  }, {
    enabled: !!activeSalonId,
  });

  const brands = brandsData?.brands || [];
  const categories = categoriesData?.categories || [];
  const suppliers = suppliersData?.suppliers || [];

  const handleOpenModal = (product: any = null) => {
    setSelectedProduct(product);
    setIsModalOpen(true);
  };

  const handleCloseModal = () => {
    setSelectedProduct(null);
    setIsModalOpen(false);
  };

  const handleDeleteProduct = (product: any) => {
    if (!activeSalonId) {
      toast({
        title: 'Erro',
        description: 'Nenhum salão ativo',
        variant: 'destructive',
      });
      return;
    }

    setProductToDelete(product);
    setIsDeleteDialogOpen(true);
  };

  const confirmDeleteProduct = async () => {
    if (!productToDelete || !activeSalonId) return;

    try {
      await deleteProduct({
        productId: productToDelete.id,
        salonId: activeSalonId,
      });

      toast({
        title: 'Produto excluído',
        description: 'Produto removido com sucesso',
      });

      await refetch();
    } catch (error: any) {
      toast({
        title: 'Erro',
        description: error.message || 'Erro ao excluir produto',
        variant: 'destructive',
      });
    } finally {
      setIsDeleteDialogOpen(false);
      setProductToDelete(null);
    }
  };

  const handleToggleColumn = (columnId: string) => {
    setVisibleColumns(prev => 
      prev.includes(columnId) 
        ? prev.filter(id => id !== columnId)
        : [...prev, columnId]
    );
  };

  const handleClearFilters = () => {
    setFilterCategory('all');
    setFilterBrand('all');
    setFilterSupplier('all');
    setFilterLowStock(false);
    setFilterStatus('all');
    setSearch('');
  };

  const hasActiveFilters = filterCategory !== 'all' || filterBrand !== 'all' || 
    filterSupplier !== 'all' || filterLowStock || filterStatus !== 'all' || search !== '';

  const formatCurrency = (value: number) => {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL',
    }).format(value);
  };

  // Calculate stats
  const stats = useMemo(() => {
    if (!data?.products) {
      return { total: 0, active: 0, inactive: 0, lowStock: 0, favorites: 0 };
    }

    return {
      total: data.products.length,
      active: data.products.filter((p: any) => p.isActive).length,
      inactive: data.products.filter((p: any) => !p.isActive).length,
      lowStock: data.products.filter((p: any) => p.stockQuantity <= p.minimumStock).length,
      favorites: data.products.filter((p: any) => p.isFavorite).length,
    };
  }, [data]);

  // Filter and sort products
  const filteredAndSortedProducts = useMemo(() => {
    if (!data?.products) return [];

    return data.products
      .filter((product: any) => {
        // Search filter
        if (search) {
          const searchLower = search.toLowerCase();
          const matchesName = product.name.toLowerCase().includes(searchLower);
          const matchesBarcode = product.barcode?.toLowerCase().includes(searchLower);
          const matchesSku = product.sku?.toLowerCase().includes(searchLower);
          if (!matchesName && !matchesBarcode && !matchesSku) return false;
        }
        
        // Category filter
        if (filterCategory !== 'all' && product.categoryId !== filterCategory) {
          return false;
        }
        
        // Brand filter
        if (filterBrand !== 'all' && product.brandId !== filterBrand) {
          return false;
        }
        
        // Supplier filter
        if (filterSupplier !== 'all' && product.supplierId !== filterSupplier) {
          return false;
        }
        
        // Status filter
        if (filterStatus === 'active' && !product.isActive) return false;
        if (filterStatus === 'inactive' && product.isActive) return false;
        
        // Low stock filter
        if (filterLowStock && product.stockQuantity > product.minimumStock) {
          return false;
        }
        
        return true;
      })
      .sort((a: any, b: any) => {
        let aValue, bValue;
        switch (sortBy) {
          case 'name':
            aValue = a.name.toLowerCase();
            bValue = b.name.toLowerCase();
            break;
          case 'price':
            aValue = a.salePrice || 0;
            bValue = b.salePrice || 0;
            break;
          case 'cost':
            aValue = a.costPrice || 0;
            bValue = b.costPrice || 0;
            break;
          case 'stock':
            aValue = a.stockQuantity || 0;
            bValue = b.stockQuantity || 0;
            break;
          case 'category':
            aValue = a.category?.name?.toLowerCase() || '';
            bValue = b.category?.name?.toLowerCase() || '';
            break;
          case 'brand':
            aValue = a.brand?.name?.toLowerCase() || '';
            bValue = b.brand?.name?.toLowerCase() || '';
            break;
          default:
            return 0;
        }
        if (aValue < bValue) return sortOrder === 'asc' ? -1 : 1;
        if (aValue > bValue) return sortOrder === 'asc' ? 1 : -1;
        return 0;
      });
  }, [data, search, filterCategory, filterBrand, filterSupplier, filterStatus, filterLowStock, sortBy, sortOrder]);

  return (
    <div className='space-y-6'>
      {/* Stats Cards */}
      <div className='grid gap-4 md:grid-cols-5'>
        <Card>
          <CardHeader className='flex flex-row items-center justify-between space-y-0 pb-2'>
            <CardTitle className='text-sm font-medium'>Total de Produtos</CardTitle>
            <Package className='h-4 w-4 text-muted-foreground' />
          </CardHeader>
          <CardContent>
            <div className='text-2xl font-bold'>{stats.total}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className='flex flex-row items-center justify-between space-y-0 pb-2'>
            <CardTitle className='text-sm font-medium'>Ativos</CardTitle>
            <div className='h-2 w-2 bg-green-500 rounded-full' />
          </CardHeader>
          <CardContent>
            <div className='text-2xl font-bold'>{stats.active}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className='flex flex-row items-center justify-between space-y-0 pb-2'>
            <CardTitle className='text-sm font-medium'>Inativos</CardTitle>
            <div className='h-2 w-2 bg-gray-500 rounded-full' />
          </CardHeader>
          <CardContent>
            <div className='text-2xl font-bold'>{stats.inactive}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className='flex flex-row items-center justify-between space-y-0 pb-2'>
            <CardTitle className='text-sm font-medium'>Estoque Baixo</CardTitle>
            <TrendingDown className='h-4 w-4 text-destructive' />
          </CardHeader>
          <CardContent>
            <div className='text-2xl font-bold text-destructive'>{stats.lowStock}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className='flex flex-row items-center justify-between space-y-0 pb-2'>
            <CardTitle className='text-sm font-medium'>Favoritos</CardTitle>
            <Star className='h-4 w-4 text-yellow-500' />
          </CardHeader>
          <CardContent>
            <div className='text-2xl font-bold'>{stats.favorites}</div>
          </CardContent>
        </Card>
      </div>

      {/* Main Card */}
      <Card>
        <CardHeader>
          <div className='flex items-center justify-between'>
            <div>
              <CardTitle>Produtos</CardTitle>
              <p className='text-sm text-muted-foreground mt-1'>
                Gerencie os produtos do seu salão
              </p>
            </div>
            <Button onClick={() => handleOpenModal()}>
              <Plus className='mr-2 h-4 w-4' />
              Novo Produto
            </Button>
          </div>
        </CardHeader>

        <CardContent className='space-y-4'>
          {/* Filters */}
          <div className='space-y-4'>
            <div className='flex items-center gap-2'>
              <Filter className='h-4 w-4 text-muted-foreground' />
              <span className='text-sm font-medium'>Filtros</span>
              {hasActiveFilters && (
                <Button
                  variant='ghost'
                  size='sm'
                  onClick={clearFilters}
                  className='h-7'
                >
                  <X className='mr-1 h-3 w-3' />
                  Limpar
                </Button>
              )}
            </div>

            <div className='grid gap-4 md:grid-cols-4'>
              {/* Search */}
              <div>
                <Label htmlFor='search'>Buscar</Label>
                <div className='relative'>
                  <Search className='absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground' />
                  <Input
                    id='search'
                    placeholder='Nome, código, barras...'
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    className='pl-9'
                  />
                </div>
              </div>

              {/* Category Filter */}
              <div>
                <Label htmlFor='filterCategory'>Categoria</Label>
                <Select value={filterCategory} onValueChange={setFilterCategory}>
                  <SelectTrigger id='filterCategory'>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value='all'>Todas</SelectItem>
                    {categories.map((cat: any) => (
                      <SelectItem key={cat.id} value={cat.id}>
                        {cat.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Brand Filter */}
              <div>
                <Label htmlFor='filterBrand'>Marca</Label>
                <Select value={filterBrand} onValueChange={setFilterBrand}>
                  <SelectTrigger id='filterBrand'>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value='all'>Todas</SelectItem>
                    {brands.map((brand: any) => (
                      <SelectItem key={brand.id} value={brand.id}>
                        {brand.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Supplier Filter */}
              <div>
                <Label htmlFor='filterSupplier'>Fornecedor</Label>
                <Select value={filterSupplier} onValueChange={setFilterSupplier}>
                  <SelectTrigger id='filterSupplier'>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value='all'>Todos</SelectItem>
                    {suppliers.map((supplier: any) => (
                      <SelectItem key={supplier.id} value={supplier.id}>
                        {supplier.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Status Filter */}
              <div>
                <Label htmlFor='filterStatus'>Status</Label>
                <Select value={filterStatus} onValueChange={setFilterStatus}>
                  <SelectTrigger id='filterStatus'>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value='all'>Todos</SelectItem>
                    <SelectItem value='active'>Ativos</SelectItem>
                    <SelectItem value='inactive'>Inativos</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {/* Low Stock Filter */}
              <div className='flex items-end'>
                <Button
                  variant={filterLowStock ? 'default' : 'outline'}
                  onClick={() => setFilterLowStock(!filterLowStock)}
                  className='w-full'
                >
                  <TrendingDown className='mr-2 h-4 w-4' />
                  Estoque Baixo
                </Button>
              </div>

              {/* Sort By */}
              <div>
                <Label htmlFor='sortBy'>Ordenar Por</Label>
                <Select value={sortBy} onValueChange={setSortBy}>
                  <SelectTrigger id='sortBy'>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value='name'>Nome</SelectItem>
                    <SelectItem value='salePrice'>Preço de Venda</SelectItem>
                    <SelectItem value='costPrice'>Custo</SelectItem>
                    <SelectItem value='stockQuantity'>Estoque</SelectItem>
                    <SelectItem value='category'>Categoria</SelectItem>
                    <SelectItem value='brand'>Marca</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {/* Sort Order */}
              <div>
                <Label htmlFor='sortOrder'>Ordem</Label>
                <Select value={sortOrder} onValueChange={(value) => setSortOrder(value as any)}>
                  <SelectTrigger id='sortOrder'>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value='asc'>Crescente</SelectItem>
                    <SelectItem value='desc'>Decrescente</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </div>

          {/* Table */}
          {isLoading ? (
            <div className='flex items-center justify-center py-12'>
              <div className='text-center space-y-2'>
                <div className='animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto' />
                <p className='text-sm text-muted-foreground'>Carregando produtos...</p>
              </div>
            </div>
          ) : paginatedProducts.length === 0 ? (
            <div className='flex flex-col items-center justify-center py-12 text-center'>
              <Package className='h-12 w-12 text-muted-foreground mb-4' />
              <h3 className='text-lg font-semibold mb-2'>Nenhum produto encontrado</h3>
              <p className='text-sm text-muted-foreground mb-4'>
                {hasActiveFilters
                  ? 'Nenhum produto corresponde aos filtros aplicados'
                  : 'Comece adicionando seu primeiro produto'}
              </p>
              {hasActiveFilters ? (
                <Button variant='outline' onClick={clearFilters}>
                  Limpar Filtros
                </Button>
              ) : (
                <Button onClick={() => handleOpenModal()}>
                  <Plus className='mr-2 h-4 w-4' />
                  Adicionar Produto
                </Button>
              )}
            </div>
          ) : (
            <>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Produto</TableHead>
                    <TableHead>Categoria</TableHead>
                    <TableHead>Marca</TableHead>
                    <TableHead className='text-right'>Custo</TableHead>
                    <TableHead className='text-right'>Venda</TableHead>
                    <TableHead className='text-center'>Estoque</TableHead>
                    <TableHead>Status</TableHead>
                    <TableHead className='text-right'>Ações</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {paginatedProducts.map((product: any) => (
                    <TableRow key={product.id}>
                      <TableCell>
                        <div className='flex items-center gap-2'>
                          {product.isFavorite && (
                            <Star className='h-3 w-3 text-yellow-500 fill-yellow-500' />
                          )}
                          <div>
                            <div className='font-medium'>{product.name}</div>
                            {product.sku && (
                              <div className='text-xs text-muted-foreground'>
                                SKU: {product.sku}
                              </div>
                            )}
                          </div>
                        </div>
                      </TableCell>
                      <TableCell>
                        {product.category?.name || (
                          <span className='text-muted-foreground'>-</span>
                        )}
                      </TableCell>
                      <TableCell>
                        {product.brand?.name || (
                          <span className='text-muted-foreground'>-</span>
                        )}
                      </TableCell>
                      <TableCell className='text-right'>
                        {formatCurrency(product.costPrice)}
                      </TableCell>
                      <TableCell className='text-right'>
                        {formatCurrency(product.salePrice)}
                      </TableCell>
                      <TableCell className='text-center'>
                        <Badge
                          variant={
                            product.stockQuantity <= product.minimumStock
                              ? 'destructive'
                              : 'secondary'
                          }
                        >
                          {product.stockQuantity}
                        </Badge>
                      </TableCell>
                      <TableCell>
                        <Badge variant={product.isActive ? 'default' : 'secondary'}>
                          {product.isActive ? 'Ativo' : 'Inativo'}
                        </Badge>
                      </TableCell>
                      <TableCell className='text-right'>
                        <div className='flex justify-end gap-2'>
                          <Button
                            variant='ghost'
                            size='sm'
                            onClick={() => handleOpenModal(product)}
                            title='Editar'
                          >
                            <Edit className='h-4 w-4' />
                          </Button>
                          <Button
                            variant='ghost'
                            size='sm'
                            onClick={() => setProductToDelete(product)}
                            title='Excluir'
                          >
                            <Trash2 className='h-4 w-4 text-destructive' />
                          </Button>
                        </div>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>

              {/* Pagination */}
              <div className='flex items-center justify-between border-t px-6 py-4'>
                <div className='flex items-center gap-4'>
                  <div className='text-sm text-muted-foreground'>
                    Mostrando {startIndex + 1}-{Math.min(endIndex, allFilteredProducts.length)} de {allFilteredProducts.length} produto{allFilteredProducts.length !== 1 ? 's' : ''}
                  </div>
                  <select
                    value={perPage}
                    onChange={(e) => {
                      setPerPage(Number(e.target.value));
                      setPage(1);
                    }}
                    className='h-8 rounded-md border border-input bg-background px-3 pr-8 text-sm'
                  >
                    <option value={10}>10</option>
                    <option value={25}>25</option>
                    <option value={50}>50</option>
                    <option value={100}>100</option>
                  </select>
                </div>
                <div className='flex items-center space-x-2'>
                  <Button
                    variant='outline'
                    size='sm'
                    onClick={() => setPage(page - 1)}
                    disabled={page === 1}
                  >
                    Anterior
                  </Button>
                  <div className='flex items-center gap-1 px-2'>
                    <span className='text-sm'>
                      Página {page} de {totalPages || 1}
                    </span>
                  </div>
                  <Button
                    variant='outline'
                    size='sm'
                    onClick={() => setPage(page + 1)}
                    disabled={page >= totalPages}
                  >
                    Próxima
                  </Button>
                </div>
              </div>
            </>
          )}
        </CardContent>
      </Card>

      <ProductFormModal
        isOpen={isModalOpen}
        onClose={handleCloseModal}
        onSuccess={handleSuccess}
        product={editingProduct}
        salonId={salonId}
      />

      <AlertDialog open={!!productToDelete} onOpenChange={() => setProductToDelete(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Confirmar Exclusão</AlertDialogTitle>
            <AlertDialogDescription>
              Tem certeza que deseja excluir o produto "{productToDelete?.name}"? Esta ação não pode ser desfeita.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancelar</AlertDialogCancel>
            <AlertDialogAction onClick={handleDeleteProduct} className='bg-destructive text-destructive-foreground hover:bg-destructive/90'>
              Excluir
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}
